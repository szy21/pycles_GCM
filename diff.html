<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>diff</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="settings" content="whole_filler,use_css,no_foldcolumn,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
pre { font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
* { font-size: 1em; }
.Comment { color: #0000c0; }
.Identifier { color: #008080; }
.Constant { color: #c00000; }
.Folded { color: #0000c0; background-color: #a8a8a8; padding-bottom: 1px; }
.Statement { color: #af5f00; }
.PreProc { color: #c000c0; }
.Type { color: #008000; }
.DiffAdd { background-color: #ffd7d7; padding-bottom: 1px; }
.DiffChange { background-color: #ffd7ff; padding-bottom: 1px; }
.DiffDelete { color: #8080ff; background-color: #afffff; padding-bottom: 1px; }
.DiffText { background-color: #ff6060; padding-bottom: 1px; font-weight: bold; }
-->
<!--
table { table-layout: fixed; }
html, body, table, tbody { width: 100%; margin: 0; padding: 0; }
th, td { width: 50.0%; }
td div { overflow: auto; }
-->
</style>
<script type='text/javascript'>
<!--

/* function to open any folds containing a jumped-to line before jumping to it */
function JumpToLine()
{
  var lineNum;
  lineNum = window.location.hash;
  lineNum = lineNum.substr(1); /* strip off '#' */

  if (lineNum.indexOf('L') == -1) {
    lineNum = 'L'+lineNum;
  }
  if (lineNum.indexOf('W') == -1) {
    lineNum = 'W1'+lineNum;
  }
  lineElem = document.getElementById(lineNum);
  /* Always jump to new location even if the line was hidden inside a fold, or
   * we corrected the raw number to a line ID.
   */
  if (lineElem) {
    lineElem.scrollIntoView(true);
  }
  return true;
}
if ('onhashchange' in window) {
  window.onhashchange = JumpToLine;
}

-->
</script>
</head>
<body>
<table border='1' width='100%' id='vimCodeElement'>
<tr>
<th>ReferenceState.pyx</th>
<th>/central/home/zhaoyi/pycles/ReferenceState.pyx</th>
</tr><tr>
<td valign="top"><div>
<pre>
<span class="Folded">+-- 10 lines: !python------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="PreProc">from</span> NetCDFIO <span class="PreProc">cimport</span> NetCDFIO_Stats
<span class="PreProc">cimport</span> ParallelMPI
<span class="PreProc">from</span> scipy.integrate <span class="PreProc">import</span> odeint
<span class="PreProc">include</span> <span class="Constant">'parameters.pxi'</span>

<span class="Statement">cdef</span> <span class="Statement">extern</span> <span class="PreProc">from</span> <span class="Constant">&quot;thermodynamic_functions.h&quot;</span>:
<span class="DiffChange">    </span><span class="DiffText">inline </span><span class="Type DiffChange">double</span><span class="DiffChange"> qt_</span><span class="PreProc DiffChange">from</span><span class="DiffChange">_pv(</span><span class="Type DiffChange">double</span><span class="DiffChange"> p0, </span><span class="Type DiffChange">double</span><span class="DiffChange"> pv)                                                                                                                                                                                     </span>
<span class="DiffAdd">    inline </span><span class="Type DiffAdd">double</span><span class="DiffAdd"> thetali_c(</span><span class="Type DiffAdd">double</span><span class="DiffAdd"> p0, </span><span class="Type DiffAdd">double</span><span class="DiffAdd"> T, </span><span class="Type DiffAdd">double</span><span class="DiffAdd"> qt, </span><span class="Type DiffAdd">double</span><span class="DiffAdd"> ql, </span><span class="Type DiffAdd">double</span><span class="DiffAdd"> qi, </span><span class="Type DiffAdd">double</span><span class="DiffAdd"> L)                                                                                                                                            </span>

<span class="Statement">cdef</span> <span class="Statement">class</span> <span class="Identifier">ReferenceState</span>:
    <span class="Statement">def</span> <span class="Identifier">__init__</span>(self, Grid.Grid Gr ):

        self.p0 = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.p0_half = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.alpha0 = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.alpha0_half = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.rho0 = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.rho0_half = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="DiffAdd">        self.thetali0 = np.zeros(Gr.dims.nlg[</span><span class="Constant DiffAdd">2</span><span class="DiffAdd">], dtype=np.</span><span class="Type DiffAdd">double</span><span class="DiffAdd">, order=</span><span class="Constant DiffAdd">'c'</span><span class="DiffAdd">)                                                                                                                                                           </span>
<span class="DiffAdd">        self.thetali0_half = np.zeros(Gr.dims.nlg[</span><span class="Constant DiffAdd">2</span><span class="DiffAdd">], dtype=np.</span><span class="Type DiffAdd">double</span><span class="DiffAdd">, order=</span><span class="Constant DiffAdd">'c'</span><span class="DiffAdd">)                                                                                                                                                      </span>


        self.p0_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.p0_half_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.alpha0_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.alpha0_half_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.rho0_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.rho0_half_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="DiffAdd">        self.thetali0_global =  np.zeros(Gr.dims.ng[</span><span class="Constant DiffAdd">2</span><span class="DiffAdd">], dtype=np.</span><span class="Type DiffAdd">double</span><span class="DiffAdd">, order=</span><span class="Constant DiffAdd">'c'</span><span class="DiffAdd">)                                                                                                                                                    </span>
<span class="DiffAdd">        self.thetali0_half_global =  np.zeros(Gr.dims.ng[</span><span class="Constant DiffAdd">2</span><span class="DiffAdd">], dtype=np.</span><span class="Type DiffAdd">double</span><span class="DiffAdd">, order=</span><span class="Constant DiffAdd">'c'</span><span class="DiffAdd">)                                                                                                                                               </span>

        <span class="Statement">return</span>

    <span class="Statement">def</span> <span class="Identifier">initialize</span>(self, Grid.Grid Gr, Thermodynamics, NetCDFIO_Stats NS, ParallelMPI.ParallelMPI Pa):
        <span class="Constant">'''</span>
<span class="Constant">        Initilize the reference profiles. The function is typically called from the case specific initialization</span>
<span class="Folded">+-- 11 lines: fucntion defined in Initialization.pyx-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="Comment"># determine the reference pressure</span>
        <span class="Statement">def</span> <span class="Identifier">rhs</span>(p, z):
            T, ql, qi = Thermodynamics.eos(np.exp(p), self.sg, self.qtg)
            <span class="Statement">return</span> -g / (Rd * T * (<span class="Constant">1.0</span> - self.qtg + eps_vi * (self.qtg - ql - qi)))

        <span class="Comment"># Construct arrays for integration points</span>
<span class="DiffChange">        z = np.array(Gr.z</span><span class="DiffText">p</span><span class="DiffChange">[Gr.dims.gw - </span><span class="Constant DiffChange">1</span><span class="DiffChange">:-Gr.dims.gw + </span><span class="Constant DiffChange">1</span><span class="DiffChange">])                                                                                                                                                                            </span>
<span class="DiffChange">        z_half = np.append([</span><span class="Constant DiffChange">0.0</span><span class="DiffChange">], np.array(Gr.z</span><span class="DiffText">p</span><span class="DiffChange">_half[Gr.dims.gw:-Gr.dims.gw]))                                                                                                                                                        </span>

        <span class="Comment"># We are integrating the log pressure so need to take the log of the</span>
        <span class="Comment"># surface pressure</span>
        p0 = np.log(self.Pg)

        p = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="Folded">+-- 13 lines: p_half = np.zeros(Gr.dims.ng[2], dtype=np.double, order='c')-------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        p = np.exp(p)
        p_half = np.exp(p_half)

        self.p0_global = p
        self.p0_half_global = p_half

<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] p_ = p
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] p_half_ = p_half
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] temperature = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] temperature_half = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] alpha = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] alpha_half = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="DiffAdd">        </span><span class="Statement DiffAdd">cdef</span><span class="DiffAdd"> </span><span class="Type DiffAdd">double</span><span class="DiffAdd"> [:] thetali =  np.zeros(Gr.dims.ng[</span><span class="Constant DiffAdd">2</span><span class="DiffAdd">], dtype=np.</span><span class="Type DiffAdd">double</span><span class="DiffAdd">, order=</span><span class="Constant DiffAdd">'c'</span><span class="DiffAdd">)                                                                                                                                                 </span>
<span class="DiffAdd">        </span><span class="Statement DiffAdd">cdef</span><span class="DiffAdd"> </span><span class="Type DiffAdd">double</span><span class="DiffAdd"> [:] thetali_half = np.zeros(Gr.dims.ng[</span><span class="Constant DiffAdd">2</span><span class="DiffAdd">], dtype=np.</span><span class="Type DiffAdd">double</span><span class="DiffAdd">, order=</span><span class="Constant DiffAdd">'c'</span><span class="DiffAdd">)                                                                                                                                             </span>

        <span class="Statement">cdef</span> <span class="Type">double</span>[:] ql = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] qi = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] qv = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)

        <span class="Statement">cdef</span> <span class="Type">double</span>[:] ql_half = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="Folded">+--  2 lines: cdef double[:] qi_half = np.zeros(Gr.dims.ng[2], dtype=np.double, order='c')---------------------------------------------------------------------------------------------------------------------------------------------</span>

        <span class="Comment"># Compute reference state thermodynamic profiles</span>
        <span class="Statement">for</span> k <span class="Statement">in</span> <span class="Identifier">xrange</span>(Gr.dims.ng[<span class="Constant">2</span>]):
            temperature[k], ql[k], qi[k] = Thermodynamics.eos(p_[k], self.sg, self.qtg)
            qv[k] = self.qtg - (ql[k] + qi[k])
            alpha[k] = Thermodynamics.alpha(p_[k], temperature[k], self.qtg, qv[k])
<span class="DiffAdd">            thetali[k] = thetali_c(p_[k], temperature[k], self.qtg, ql[k], qi[k], Thermodynamics.get_lh(temperature[k]))</span><span class="DiffAdd">                                                                                                               </span>

            temperature_half[k], ql_half[k], qi_half[k] = Thermodynamics.eos(p_half_[k], self.sg, self.qtg)
            qv_half[k] = self.qtg - (ql_half[k] + qi_half[k])
            alpha_half[k] = Thermodynamics.alpha(p_half_[k], temperature_half[k], self.qtg, qv_half[k])
<span class="DiffAdd">            thetali_half[k] = thetali_c(p_half_[k], temperature_half[k], self.qtg, ql_half[k], qi_half[k], Thermodynamics.get_lh(temperature_half[k]))</span><span class="DiffAdd">                                                                                 </span>

        <span class="Comment"># Now do a sanity check to make sure that the Reference State entropy profile is uniform following</span>
        <span class="Comment"># saturation adjustment</span>
        <span class="Statement">cdef</span> <span class="Type">double</span> s
        <span class="Statement">for</span> k <span class="Statement">in</span> <span class="Identifier">xrange</span>(Gr.dims.ng[<span class="Constant">2</span>]):
            s = Thermodynamics.entropy(p_half[k],temperature_half[k],self.qtg,ql_half[k],qi_half[k])
            <span class="Statement">if</span> np.<span class="Identifier">abs</span>(s - self.sg)/self.sg &gt; <span class="Constant">0.01</span>:
                Pa.root_print(<span class="Constant">'Error in reference profiles entropy not constant !'</span>)
                Pa.root_print(<span class="Constant">'Likely error in saturation adjustment'</span>)
                Pa.root_print(<span class="Constant">'Kill Simulation Now!'</span>)
                Pa.kill()

<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        self.alpha0_global = alpha
        self.alpha0_half_global = alpha_half
        self.rho0_global = <span class="Constant">1.0</span>/np.array(self.alpha0_global)
        self.rho0_half_global = <span class="Constant">1.0</span>/np.array(self.alpha0_half_global)

<span class="DiffAdd">        self.thetali0_global = thetali</span><span class="DiffAdd">                                                                                                                                                                                                 </span>
<span class="DiffAdd">        self.thetali0_half_global = thetali_half</span><span class="DiffAdd">                                                                                                                                                                                       </span>
<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
        <span class="Comment"># print(np.array(Gr.extract_local_ghosted(alpha_half,2)))</span>
        self.alpha0_half = Gr.extract_local_ghosted(alpha_half, <span class="Constant">2</span>)
        self.alpha0 = Gr.extract_local_ghosted(alpha, <span class="Constant">2</span>)
        self.p0 = Gr.extract_local_ghosted(p_, <span class="Constant">2</span>)
        self.p0_half = Gr.extract_local_ghosted(p_half, <span class="Constant">2</span>)
        self.rho0 = <span class="Constant">1.0</span> / np.array(self.alpha0)
        self.rho0_half = <span class="Constant">1.0</span> / np.array(self.alpha0_half)

<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
<span class="DiffAdd">        self.thetali0 =  Gr.extract_local_ghosted(thetali, </span><span class="Constant DiffAdd">2</span><span class="DiffAdd">)                                                                                                                                                                          </span>
<span class="DiffAdd">        self.thetali0_half = Gr.extract_local_ghosted(thetali_half,</span><span class="Constant DiffAdd">2</span><span class="DiffAdd">)                                                                                                                                                                  </span>
<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
        <span class="Comment"># Write reference profiles to StatsIO</span>
        <span class="Comment"># Output specific volume</span>
        units = <span class="Constant">r'm^{3}kg^{-1}'</span>
        nice_name  = <span class="Constant">r'\alpha_{0}'</span>
        desc = <span class="Constant">r'reference state specific volume at half level'</span>

<span class="Folded">+-- 76 lines: NS.add_reference_profile('alpha0', Gr, Pa, units=units, nice_name = nice_name, desc=desc)--------------------------------------------------------------------------------------------------------------------------------</span>
        Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'u0'</span>] = self.u0
        Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'v0'</span>] = self.v0

        <span class="Statement">return</span>


<span class="DiffChange">    cpdef init_</span><span class="PreProc DiffChange">from</span><span class="DiffChange">_restart(self, Grid.Grid Gr, Restart.Restart Re</span><span class="DiffText">, NetCDFIO_Stats NS, ParallelMPI.ParallelMPI Pa</span><span class="DiffChange">):                                                                                                                    </span>

        self.Tg = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'Tg'</span>]
        self.Pg = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'Pg'</span>]
        self.sg = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'sg'</span>]
        self.qtg = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'qtg'</span>]
        self.u0 = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'u0'</span>]
<span class="Folded">+-- 10 lines: self.v0 = Re.restart_data['Ref']['v0']-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        self.p0_half_global = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'p0_half_global'</span>]
        self.alpha0_global = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'alpha0_global'</span>]
        self.alpha0_half_global = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'alpha0_half_global'</span>]
        self.rho0_global = <span class="Constant">1.0</span> / Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'alpha0_global'</span>]
        self.rho0_half_global = <span class="Constant">1.0</span> / Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'alpha0_half_global'</span>]

<span class="DiffAdd">        </span><span class="Comment DiffAdd"># Output pressure</span><span class="DiffAdd">                                                                                                                                                                                                              </span>
<span class="DiffAdd">        units = </span><span class="Constant DiffAdd">r'Pa'</span><span class="DiffAdd">                                                                                                                                                                                                                  </span>
<span class="DiffAdd">        nice_name = </span><span class="Constant DiffAdd">r'p_{0}'</span><span class="DiffAdd">                                                                                                                                                                                                           </span>
<span class="DiffAdd">        desc = </span><span class="Constant DiffAdd">r'reference state pressure at half level'</span><span class="DiffAdd">                                                                                                                                                                               </span>
<span class="DiffAdd">        NS.add_reference_profile(</span><span class="Constant DiffAdd">'p0'</span><span class="DiffAdd">, Gr, Pa, units=units, nice_name = nice_name, desc=desc)                                                                                                                                          </span>
<span class="DiffAdd">        NS.write_reference_profile(</span><span class="Constant DiffAdd">'p0'</span><span class="DiffAdd">, self.p0_half[Gr.dims.gw:-Gr.dims.gw], Pa)                                                                                                                                                     </span>
<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
<span class="DiffAdd">        nice_name = </span><span class="Constant DiffAdd">r'p_{0}^{full}'</span><span class="DiffAdd">                                                                                                                                                                                                    </span>
<span class="DiffAdd">        desc = </span><span class="Constant DiffAdd">r'reference state pressure at full level'</span><span class="DiffAdd">                                                                                                                                                                               </span>
<span class="DiffAdd">        NS.add_reference_profile(</span><span class="Constant DiffAdd">'p0_full'</span><span class="DiffAdd">, Gr, Pa, units=units, nice_name = nice_name, desc=desc, z_full=</span><span class="Identifier DiffAdd">True</span><span class="DiffAdd">)                                                                                                                        </span>
<span class="DiffAdd">        NS.write_reference_profile(</span><span class="Constant DiffAdd">'p0_full'</span><span class="DiffAdd">, self.p0[Gr.dims.gw:-Gr.dims.gw], Pa)                                                                                                                                                     </span>
<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
<span class="DiffAdd">        </span><span class="Comment DiffAdd"># Output densities</span><span class="DiffAdd">                                                                                                                                                                                                             </span>
<span class="DiffAdd">        units = </span><span class="Constant DiffAdd">r'kgm^{-3}'</span><span class="DiffAdd">                                                                                                                                                                                                            </span>
<span class="DiffAdd">        nice_name = </span><span class="Constant DiffAdd">r'\rho_{0}'</span><span class="DiffAdd">                                                                                                                                                                                                        </span>
<span class="DiffAdd">        desc = </span><span class="Constant DiffAdd">r'reference state density at half level'</span><span class="DiffAdd">                                                                                                                                                                                </span>
<span class="DiffAdd">        NS.add_reference_profile(</span><span class="Constant DiffAdd">'rho0'</span><span class="DiffAdd">, Gr, Pa, units=units, nice_name = nice_name, desc=desc)                                                                                                                                        </span>
<span class="DiffAdd">        NS.write_reference_profile(</span><span class="Constant DiffAdd">'rho0'</span><span class="DiffAdd">, </span><span class="Constant DiffAdd">1.0</span><span class="DiffAdd"> / np.array(self.alpha0_half[Gr.dims.gw:-Gr.dims.gw]), Pa)                                                                                                                               </span>
<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
<span class="DiffAdd">        nice_name = </span><span class="Constant DiffAdd">r'\rho_0^{full}'</span><span class="DiffAdd">                                                                                                                                                                                                   </span>
<span class="DiffAdd">        desc = </span><span class="Constant DiffAdd">r'reference state density at full level'</span><span class="DiffAdd">                                                                                                                                                                                </span>
<span class="DiffAdd">        NS.add_reference_profile(</span><span class="Constant DiffAdd">'rho0_full'</span><span class="DiffAdd">, Gr, Pa, units=units, nice_name = nice_name, desc=desc, z_full=</span><span class="Identifier DiffAdd">True</span><span class="DiffAdd">)                                                                                                                      </span>
<span class="DiffAdd">        NS.write_reference_profile(</span><span class="Constant DiffAdd">'rho0_full'</span><span class="DiffAdd">, </span><span class="Constant DiffAdd">1.0</span><span class="DiffAdd"> / np.array(self.alpha0[Gr.dims.gw:-Gr.dims.gw]), Pa)                                                                                                                               </span>


        <span class="Statement">return</span>
</pre>
</div></td>
<td valign="top"><div>
<pre>
<span class="Folded">+-- 10 lines: !python------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="PreProc">from</span> NetCDFIO <span class="PreProc">cimport</span> NetCDFIO_Stats
<span class="PreProc">cimport</span> ParallelMPI
<span class="PreProc">from</span> scipy.integrate <span class="PreProc">import</span> odeint
<span class="PreProc">include</span> <span class="Constant">'parameters.pxi'</span>

<span class="Statement">cdef</span> <span class="Statement">extern</span> <span class="PreProc">from</span> <span class="Constant">&quot;thermodynamic_functions.h&quot;</span>:
<span class="DiffChange">    </span><span class="Type DiffChange">double</span><span class="DiffChange"> qt_</span><span class="PreProc DiffChange">from</span><span class="DiffChange">_pv(</span><span class="Type DiffChange">double</span><span class="DiffChange"> p0, </span><span class="Type DiffChange">double</span><span class="DiffChange"> pv)                                                                                                                                                                                            </span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>

<span class="Statement">cdef</span> <span class="Statement">class</span> <span class="Identifier">ReferenceState</span>:
    <span class="Statement">def</span> <span class="Identifier">__init__</span>(self, Grid.Grid Gr ):

        self.p0 = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.p0_half = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.alpha0 = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.alpha0_half = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.rho0 = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.rho0_half = np.zeros(Gr.dims.nlg[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>


        self.p0_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.p0_half_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.alpha0_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.alpha0_half_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.rho0_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        self.rho0_half_global = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>

        <span class="Statement">return</span>

    <span class="Statement">def</span> <span class="Identifier">initialize</span>(self, Grid.Grid Gr, Thermodynamics, NetCDFIO_Stats NS, ParallelMPI.ParallelMPI Pa):
        <span class="Constant">'''</span>
<span class="Constant">        Initilize the reference profiles. The function is typically called from the case specific initialization</span>
<span class="Folded">+-- 11 lines: fucntion defined in Initialization.pyx-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="Comment"># determine the reference pressure</span>
        <span class="Statement">def</span> <span class="Identifier">rhs</span>(p, z):
            T, ql, qi = Thermodynamics.eos(np.exp(p), self.sg, self.qtg)
            <span class="Statement">return</span> -g / (Rd * T * (<span class="Constant">1.0</span> - self.qtg + eps_vi * (self.qtg - ql - qi)))

        <span class="Comment"># Construct arrays for integration points</span>
<span class="DiffChange">        z = np.array(Gr.z[Gr.dims.gw - </span><span class="Constant DiffChange">1</span><span class="DiffChange">:-Gr.dims.gw + </span><span class="Constant DiffChange">1</span><span class="DiffChange">])                                                                                                                                                                             </span>
<span class="DiffChange">        z_half = np.append([</span><span class="Constant DiffChange">0.0</span><span class="DiffChange">], np.array(Gr.z_half[Gr.dims.gw:-Gr.dims.gw]))                                                                                                                                                         </span>

        <span class="Comment"># We are integrating the log pressure so need to take the log of the</span>
        <span class="Comment"># surface pressure</span>
        p0 = np.log(self.Pg)

        p = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="Folded">+-- 13 lines: p_half = np.zeros(Gr.dims.ng[2], dtype=np.double, order='c')-------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        p = np.exp(p)
        p_half = np.exp(p_half)

        self.p0_global = p
        self.p0_half_global = p_half

<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] p_ = p
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] p_half_ = p_half
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] temperature = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] temperature_half = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] alpha = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] alpha_half = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>

        <span class="Statement">cdef</span> <span class="Type">double</span>[:] ql = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] qi = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
        <span class="Statement">cdef</span> <span class="Type">double</span>[:] qv = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)

        <span class="Statement">cdef</span> <span class="Type">double</span>[:] ql_half = np.zeros(Gr.dims.ng[<span class="Constant">2</span>], dtype=np.<span class="Type">double</span>, order=<span class="Constant">'c'</span>)
<span class="Folded">+--  2 lines: cdef double[:] qi_half = np.zeros(Gr.dims.ng[2], dtype=np.double, order='c')---------------------------------------------------------------------------------------------------------------------------------------------</span>

        <span class="Comment"># Compute reference state thermodynamic profiles</span>
        <span class="Statement">for</span> k <span class="Statement">in</span> <span class="Identifier">xrange</span>(Gr.dims.ng[<span class="Constant">2</span>]):
            temperature[k], ql[k], qi[k] = Thermodynamics.eos(p_[k], self.sg, self.qtg)
            qv[k] = self.qtg - (ql[k] + qi[k])
            alpha[k] = Thermodynamics.alpha(p_[k], temperature[k], self.qtg, qv[k])
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>

            temperature_half[k], ql_half[k], qi_half[k] = Thermodynamics.eos(p_half_[k], self.sg, self.qtg)
            qv_half[k] = self.qtg - (ql_half[k] + qi_half[k])
            alpha_half[k] = Thermodynamics.alpha(p_half_[k], temperature_half[k], self.qtg, qv_half[k])
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>

        <span class="Comment"># Now do a sanity check to make sure that the Reference State entropy profile is uniform following</span>
        <span class="Comment"># saturation adjustment</span>
        <span class="Statement">cdef</span> <span class="Type">double</span> s
        <span class="Statement">for</span> k <span class="Statement">in</span> <span class="Identifier">xrange</span>(Gr.dims.ng[<span class="Constant">2</span>]):
            s = Thermodynamics.entropy(p_half[k],temperature_half[k],self.qtg,ql_half[k],qi_half[k])
            <span class="Statement">if</span> np.<span class="Identifier">abs</span>(s - self.sg)/self.sg &gt; <span class="Constant">0.01</span>:
                Pa.root_print(<span class="Constant">'Error in reference profiles entropy not constant !'</span>)
                Pa.root_print(<span class="Constant">'Likely error in saturation adjustment'</span>)
                Pa.root_print(<span class="Constant">'Kill Simulation Now!'</span>)
                Pa.kill()

<span class="DiffAdd"> </span><span class="DiffAdd">                                                                                                                                                                                                                                      </span>
        self.alpha0_global = alpha
        self.alpha0_half_global = alpha_half
        self.rho0_global = <span class="Constant">1.0</span>/np.array(self.alpha0_global)
        self.rho0_half_global = <span class="Constant">1.0</span>/np.array(self.alpha0_half_global)

<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="Comment"># print(np.array(Gr.extract_local_ghosted(alpha_half,2)))</span>
        self.alpha0_half = Gr.extract_local_ghosted(alpha_half, <span class="Constant">2</span>)
        self.alpha0 = Gr.extract_local_ghosted(alpha, <span class="Constant">2</span>)
        self.p0 = Gr.extract_local_ghosted(p_, <span class="Constant">2</span>)
        self.p0_half = Gr.extract_local_ghosted(p_half, <span class="Constant">2</span>)
        self.rho0 = <span class="Constant">1.0</span> / np.array(self.alpha0)
        self.rho0_half = <span class="Constant">1.0</span> / np.array(self.alpha0_half)

<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="Comment"># Write reference profiles to StatsIO</span>
        <span class="Comment"># Output specific volume</span>
        units = <span class="Constant">r'm^{3}kg^{-1}'</span>
        nice_name  = <span class="Constant">r'\alpha_{0}'</span>
        desc = <span class="Constant">r'reference state specific volume at half level'</span>

<span class="Folded">+-- 76 lines: NS.add_reference_profile('alpha0', Gr, Pa, units=units, nice_name = nice_name, desc=desc)--------------------------------------------------------------------------------------------------------------------------------</span>
        Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'u0'</span>] = self.u0
        Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'v0'</span>] = self.v0

        <span class="Statement">return</span>


<span class="DiffChange">    cpdef init_</span><span class="PreProc DiffChange">from</span><span class="DiffChange">_restart(self, Grid.Grid Gr, Restart.Restart Re):                                                                                                                                                                   </span>

        self.Tg = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'Tg'</span>]
        self.Pg = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'Pg'</span>]
        self.sg = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'sg'</span>]
        self.qtg = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'qtg'</span>]
        self.u0 = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'u0'</span>]
<span class="Folded">+-- 10 lines: self.v0 = Re.restart_data['Ref']['v0']-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        self.p0_half_global = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'p0_half_global'</span>]
        self.alpha0_global = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'alpha0_global'</span>]
        self.alpha0_half_global = Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'alpha0_half_global'</span>]
        self.rho0_global = <span class="Constant">1.0</span> / Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'alpha0_global'</span>]
        self.rho0_half_global = <span class="Constant">1.0</span> / Re.restart_data[<span class="Constant">'Ref'</span>][<span class="Constant">'alpha0_half_global'</span>]

<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="DiffDelete">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>


        <span class="Statement">return</span>
</pre>
</div></td>
</tr>
</table>
</body>
</html>
<!-- vim: set foldmethod=manual : -->

